<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- polyfill -->
    <script src="../inc/shim/Base64.js" type="text/javascript"></script>
    <script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="../js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="../js/midi/gm.js" type="text/javascript"></script>
    <script src="../js/midi/loader.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="../js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
        globalLoop = null;
	window.onload = function () {
		
		let  getPartFromServer = function() {
		    const url = 'http://ec2-18-191-23-1.us-east-2.compute.amazonaws.com:5000/part';
		    const Http = new XMLHttpRequest();
		    Http.open("GET", url);
		    Http.send();
		    Http.onreadystatechange=(e)=>{
			//console.log(Http.responseText)
			convertPartToLoop(Http.responseText)
			setTimeout(getPartFromServer(),1000);
		    }
		}

		let convertPartToLoop = function(part) {
		    if (part && part !== '') {
			var loop = {
			    bpm: 120,
			    notes_per_measure: 16,
			    parts: []
			}
			var obj = JSON.parse(part);
			Object.keys(obj).map(x => loop.parts.push(obj[x]))
			console.log(loop)
			globalLoop = loop;
		    }
		}
	
		let getLoop = function () {
			var loop = {
				bpm: 60,
				notes_per_measure: 16,
				parts: [
					{
						instrument: 'acoustic_grand_piano',
						notes: [85, 46, 2, 68,
							8, 66, 6, 75,
							10, 36, 52, 3,
							80, 7, 69, 45],
						velocity: 20,
					},
					{
						instrument: 'synth_drum',
						notes: [64, 17, 31, 52,
							45, 5, 74, 56,
							4, 28, 32, 10,
							83, 57, 67, 79],
						velocity: 127,
					},
				]
			};
			return loop;
		};
		let playBar = function (bar) {
			var loop = getLoop();
			var parts = loop.parts;
			var instrument_numbers = {
				"acoustic_grand_piano":0,
                "synth_drum":118,
			};
			console.log(`playing bar ${bar}`)
			let bar_duration_sec = (loop.notes_per_measure / 4) * (60 / loop.bpm);
			for (var part = 0; part < parts.length; part++) {
				MIDI.programChange(part, instrument_numbers[parts[part].instrument]);
				for (var i = 0; i < parts[part].notes.length; i++) {
					let bar_fraction = i/loop.notes_per_measure;
					MIDI.chordOn(part,
						[parts[part].notes[i]],
						parts[part].velocity,
                        MIDI.getContext().currentTime + bar_fraction * bar_duration_sec,
                    );
				}
			}
			setTimeout(()=>playBar(bar+1), 1000*bar_duration_sec)
		};
		let startPlaying = function () {
			// debugger;
			let loop = getLoop();
			let bar = 0;
			let bar_duration_ms = 1000
                * (loop.notes_per_measure / 4)
                * (60 / loop.bpm);
			setTimeout(() => playBar(bar), bar_duration_ms);
		};
		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instruments: ["acoustic_grand_piano", "synth_drum"],
			onprogress: function (state, progress) {
				console.log(state, progress);
			},
			onsuccess: function () {
				startPlaying();
			}
		});
	};

</script>
</body>
</html>
