<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- polyfill -->
    <script src="../inc/shim/Base64.js" type="text/javascript"></script>
    <script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="../js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="../js/midi/gm.js" type="text/javascript"></script>
    <script src="../js/midi/loader.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="../js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">

	window.onload = function () {
		let getLoop = function () {
			var loop = {
				bpm: 60,
				notes_per_measure: 16,
				parts: [
					{
						instrument: 'acoustic_grand_piano',
						notes: [85, 46, 2, 68,
							8, 66, 6, 75,
							10, 36, 52, 3,
							80, 7, 69, 45],
						velocity: 20,
					},
					{
						instrument: 'synth_drum',
						notes: [64, 17, 31, 52,
							45, 5, 74, 56,
							4, 28, 32, 10,
							83, 57, 67, 79],
						velocity: 127,
					},
				]
			};
			return loop;
		};
		let playBar = function (bar) {
			var loop = getLoop();
			var parts = loop.parts;
			var instrument_numbers = {
				"acoustic_grand_piano":0,
                "synth_drum":118,
			};
			console.log(`playing bar ${bar}`)
			let bar_duration_sec = (loop.notes_per_measure / 4) * (60 / loop.bpm);
			let C4 = MIDI.keyToNote['C4'];
			console.log(` bar: ${bar}`);
			for (var part = 0; part < parts.length-1; part++) {
				MIDI.programChange(part, instrument_numbers[parts[part].instrument]);
				console.log(` playing ${MIDI.noteToKey[C4+bar]}`)
				for (var i = 0; i < parts[part].notes.length; i++) {
					let bar_fraction = i/loop.notes_per_measure;
					let bar_time = bar + bar_fraction;
					// console.log(` bar_time: ${bar_time}`)
					MIDI.chordOn(part,
						// [parts[part].notes[i]],
						[C4+bar],
						parts[part].velocity,
                        (bar_time) * bar_duration_sec,
                    );
				}
			}
			setTimeout(()=>playBar(bar+1), 1000*bar_duration_sec)
		};
		let startPlaying = function () {
			// debugger;
			let loop = getLoop();
			let bar = 0;
			let bar_duration_ms = 1000
                * (loop.notes_per_measure / 4)
                * (60 / loop.bpm);
			setTimeout(() => playBar(bar), bar_duration_ms);
		};
		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instruments: ["acoustic_grand_piano", "synth_drum"],
			onprogress: function (state, progress) {
				console.log(state, progress);
			},
			onsuccess: function () {
				startPlaying();
			}
		});
	};

</script>
</body>
</html>