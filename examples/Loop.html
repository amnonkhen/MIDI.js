<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- polyfill -->
    <script src="../inc/shim/Base64.js" type="text/javascript"></script>
    <script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="../js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="../js/midi/gm.js" type="text/javascript"></script>
    <script src="../js/midi/loader.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="../js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">

	window.onload = function () {
		let getLoop = function () {
			var loop = {
				bpm: 120,
				notes_per_measure: 16,
				parts: [
					{
						instrument: 'acoustic_grand_piano',
						notes: [85, 46, 2, 68,
							8, 66, 6, 75,
							10, 36, 52, 3,
							80, 7, 69, 45],
						velocity: 20,
					},
					{
						instrument: 'synth_drum',
						notes: [64, 17, 31, 52,
							45, 5, 74, 56,
							4, 28, 32, 10,
							83, 57, 67, 79],
						velocity: 127,
					},
				]
			};
			return loop;
		};
		let playBar = function (bar) {
			var loop = getLoop();
			var parts = loop.parts;

			console.log(`playing bar ${bar}`)
			for (var part = 0; part < parts.length; part++) {
				for (var i = 0; i < parts[part].notes.length; i++) {
					MIDI.chordOn(parts[part].channel,
						[parts[part].notes[i]],
						parts[part].velocity,

						((bar * parts[part].notes.length) + i) * (4 / loop.notes_per_measure) * (60 / loop.bpm));
				}
			}
		};
		let startPlaying = function () {
			// debugger;
			MIDI.programChange(0, 0);
			MIDI.programChange(1, 118);

			let loop = getLoop();
			let bar = 0;
			let bar_duration = 1000 * (loop.notes_per_measure / 4) * (60 / loop.bpm);
			setInterval(() => {
				playBar(bar)
				bar++;
			}, bar_duration);
		};
		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instruments: ["acoustic_grand_piano", "synth_drum"],
			onprogress: function (state, progress) {
				console.log(state, progress);
			},
			onsuccess: function () {
				startPlaying();
			}
		});
	};

</script>
</body>
</html>